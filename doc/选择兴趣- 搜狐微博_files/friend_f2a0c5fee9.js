kola("newt.friend.Invite",["jquery.Core","newt.tool.Copy","newt.twitter.Twitter"],function($,Copy){var msnivt=function(){var self=this;self.tipHtm={unamePre:'<p class="frm_tip" id="fi5tips"><b><i class="i"></i><em>',unameEnd:"</em></b></p>",passPre:'<p class="frmTip2" id="msn_password_tips"><b><i class="i"></i><em>',passEnd:"</em></b></p>"};$.extend(self,{copyCode:function(){var testCode=$("#inviteText").val()+" 我的微博，看看哈";var ret=Copy.copy2Clipboard(testCode);if(ret){tw.showSysMsg(ret.data)}return false},inviteSelect:function(){document.getElementById("inviteText").select()},createUTip:function(){var tip=$("#fi5tips");if(!tip||!tip.html()){var uname=$("#fi5");tip=$(self.tipHtm.unamePre+self.tipHtm.unameEnd);uname.after(tip)}return tip},showUTip:function(tipStr){var tip=self.createUTip();tip.text(tipStr)},checkMsnUserName:function(ret){var uname=$("#fi5");var flag=0;if(ret){if(!uname||!uname.val()){flag=1}}if(uname.val().length>0&&flag!=1&&!self.checkEmail(uname.val())){flag=2}var tip=self.createPTip(true);if(flag>0){var tipStr="";if(flag==1){tipStr="MSN账号不能为空"}if(flag==2){tipStr="MSN格式不正确"}self.showPTip(tip,tipStr,true)}else{if(tip){tip=self.createPTip(true)}}return flag==0?true:false},checkEmail:function(elemValue){if(!elemValue){return false}var isEmail=/^\w+((-\w+)|(\.\w+))*\@[A-Za-z0-9]+((\.|-)[A-Za-z0-9]+)*\.[A-Za-z0-9]+$/;var result=isEmail.test(elemValue);return result},createPTip:function(divId){var tip=$("#msn_password_tips");if(!tip||!tip.html()){var passwd=$("#msn_password");if(passwd){tip=$(self.tipHtm.passPre+self.tipHtm.passEnd);passwd.after(tip)}}tip.attr("class","frmTip2");tip.text("搜狐微博不会存储你的密码，请放心使用");return tip},showPTip:function(tip,tipStr,isErr){if(!tip){tip=self.createPTip()}tip.text(tipStr);if(isErr){tip.attr("class","frm_tip")}else{tip.attr("class","frmTip2")}},checkMsnPasswd:function(ret){var passwd=$("#msn_password");var flag=true;if(!passwd||!passwd.val()){flag=false}var tip=$("#msn_password_tips");if(!flag){var tipStr="MSN密码不能为空";self.showPTip(tip,tipStr,true)}else{var tipStr="搜狐微博不会存储你的密码，请放心使用";self.showPTip(tip,tipStr,false)}return flag},getAPT:function(size,type){if(type&&type==1){return'<div class="apt">你的MSN联系人中有<strong>'+size+"</strong>人还没加入搜狐微博，邀请他们关注你吧。</div>"}return'<div class="apt">你的MSN联系人中已有<strong>'+size+'</strong>人在搜狐微博中了，立即关注他们吧。<!--a class="fuc" href="javascript:void(1);"><b>返回查找好友</b></a--></div>'},getMSNAPC:function(str){var pre='<div class="apc"><p class="btns"></p><p class="selall"><label class="cbox"><input type="checkbox" id="allChkMSN"/>全选</label></p><div class="tbl2 tbl2a"><table><tbody>';pre=pre+str;pre=pre+'</tbody></table></div><p class="btns"><a class="btn btnm" href="javascript:void(1);" id="sdMsnE"><b>发送邀请</b></a></p></div>';return pre},getTUsrAPC:function(str){var pre='<div class="apc"><p class="selall"><label class="cbox"><input type="checkbox" id="allChkIVT"/>全选</label></p><div class="tbl2">	<table><tbody>';pre=pre+str+'</tbody></table></div></div><div class="apb"><p class="btns"><a class="btn btnm" href="javascript:void(1);" id="payIvtF"><b>关注他们</b></a></p><p class="opt"><a href="javascript:void(1);" class="fuc1"><b>跳过</b></a></p></div>';return pre},getTWUser:function(list){var rs=[];var len=0;if(list&&list.length>0){len=list.length}else{return""}for(var i=0;i<len;i++){var one=list[i];rs.push('<tr><td class="col_cbox"><label class="cbox"><input type="checkbox" name="chkusrIVT" value="'+one.id+'"/></label></td>');rs.push('<td class="col_avt"><p class="avt"><b><img src="'+one.pic+'" alt=""/></b></p></td>');rs.push('<td class="col_nm"><b class="nm"><b title="'+$.trim(unescape(one.name))+'">'+$.trim(unescape(one.name))+"</b></b></td>");rs.push('<td class="col_mail" title="'+$.trim(one.passport)+'"><p>'+$.trim(one.passport)+"</p></td></tr>")}return rs.join("")},getMsnUser:function(list){var rs="";if(!list||list.length<=0){return rs}for(var i=0;i<list.length;i++){var one=list[i];var oName=$.trim(unescape(one.name));var oPpt=$.trim(one.passport);rs=rs+'<tr><td class="col_cbox"><label class="cbox"><input type="checkbox" name="chkusrMSN" value="'+oPpt+'"/></label></td>';if(oName==oPpt){rs=rs+'<td><p class="tdc"><b class="nm"><b>'+oName+"</b></b></p></td>"}else{rs=rs+'<td><p class="tdc"><b class="nm"><b>'+oName+'</b></b><b class="uri">'+oPpt+"</b></p></td>"}}return rs},getErrTip:function(){var rs='<div class="hint ht_msg"><p class="ht_t"><i class="i"/><em>你的MSN联系人都加入微博了 <a href="javascript:void(1);">返回查找好友</a></em></p></div>';return rs},enterEvent:function(event){var code=event.which;if(code==13){self.login()}},login:function(){var flag=self.checkMsnUserName(true)&&self.checkMsnPasswd();if(!flag){return}var btn=$("#searchIvt");if(btn&&btn.html()){var nHtml='<a class="btn btn_dis" href="javascript:void(1);"><b><i class="i iloading"></i>正在查找中</b></a>';btn.html(nHtml);nHtml='<p class="frm_tip2"><b><i class="i"></i><em>查找时间可能较长，期间MSN可能会掉线，请耐心等待。</em></b></p>';btn.after($(nHtml));btn.children('a[class="btn btn_dis"]').unbind("click")}$("#fi5").unbind("keydown");$("#msn_password").unbind("keydown");var uname=$("#fi5").val()+"";var passwd=$("#msn_password").val()+"";$.ajax({type:"POST",url:"/follow/loadmsnusers",data:"uname="+uname+"&passwd="+passwd+"&dt="+new Date().getTime(),dataType:"json",success:function(json){if(!json){tw.showSysMsg("出了点小问题，重新试试吧!(-10)");$("#fi5").keydown(self.enterEvent);$("#msn_password").keydown(self.enterEvent);var nHtml='<a href="javascript:void(1);" class="btn"><b>查找并邀请</b></a>';btn.html(nHtml);btn.next("p").remove();btn.children("a").bind("click",self.login)}else{var flag=eval(json.data.ret);json=json.data;if(flag==1){$("#ivtWay").hide();var uList=json.uList;var uSize=json.uSize;var msnList=json.msnList;var msnSize=json.msnSize;var ivtMsn=$("#ivtmsn");ivtMsn.html(self.getAPT(uSize)+self.getTUsrAPC(self.getTWUser(uList)));var ivtMsnT=$("#ivtmsnT");ivtMsnT.html(self.getAPT(msnSize,1)+self.getMSNAPC(self.getMsnUser(msnList)));if(uSize>0){self.init(3)}else{if(msnSize>0){self.init(2)}else{self.init(4)}}}else{if(flag==0){self.init(4)}else{var tipStr="出了点小问题，重新试试吧!";switch(flag){case -1:tipStr="请您登陆";break;case -2:tipStr="MSN账号不能为空";break;case -3:tipStr="MSN密码不能为空";break;case -9:tipStr="MSN用户名或密码错误";break;default:tipStr="出了点小问题，重新试试吧!"+flag;break}switch(flag){case -2:case -3:case -9:self.showPTip($("#msn_password_tips"),tipStr,true);break;default:tw.showSysMsg(tipStr)}}}if(flag!=1){$("#fi5").keydown(self.enterEvent);$("#msn_password").keydown(self.enterEvent)}var nHtml='<a href="javascript:void(1);" class="btn"><b>查找并邀请</b></a>';btn.html(nHtml);btn.next("p").remove();btn.children("a").bind("click",self.login)}},error:function(error){tw.showSysMsg("出了点小问题，重新试试吧!(-10)",function(){$("#fi5").keydown(self.enterEvent);$("#msn_password").keydown(self.enterEvent);var nHtml='<a href="javascript:void(1);" class="btn"><b>查找并邀请</b></a>';btn.html(nHtml);btn.next("p").remove();btn.children("a").bind("click",self.login)})}})},chkAll:function(chkname,divid){var flag=$("#"+divid).attr("checked");var tmp=$(":checkbox[name="+chkname+"]");if(flag){tmp.each(function(){$(this).attr("checked",true)})}else{tmp.each(function(){$(this).attr("checked",false)})}},sendMail:function(chkname){var items=$("input[name='"+chkname+"']").filter("input:checked");if(items&&items.length>0){var mname=$("#mailName").val();var dtStr="";for(var i=0;i<items.length;i++){dtStr=dtStr+$(items[i]).val()+"|"}var dtt="msnusrs="+dtStr+"&bt="+new Date().getTime();if(mname&&mname.length>0){dtt=dtt+"&mname="+escape(mname)}$.ajax({type:"POST",url:"/follow/mailmsnuser",data:dtt,dataType:"json",success:function(json){if(json){if(json.status==0){tw.showSysMsg("恭喜！您已经成功地向好友发送了邀请。请耐心等待好友的加入。",function(){window.location.reload()})}else{tw.showSysMsg("出了点小问题，重新试试吧!")}}},error:function(error){tw.showSysMsg("出了点小问题，重新试试吧!")}})}else{tw.showSysMsg("请选中邀请的好友!")}},payAttd:function(chkname){var items=$("input[name='"+chkname+"']").filter("input:checked");if(items&&items.length>0){var dataStr="";for(var i=0;i<items.length;i++){dataStr=dataStr+$(items[i]).val()+","}tw.build({type:"follow_from_active",uid:dataStr,success:function(msg){if(msg.status==0){common.showTip("关注成功！");setTimeout(function(){$("#ivtmsn").hide();self.init(2)},3000)}else{tw.showSysMsg("出了点小问题，重新试试吧!")}},error:function(){tw.showSysMsg("出了点小问题，重新试试吧!")}})}else{tw.showSysMsg("请选中要关注的好友！")}},showStep:function(ret){if(ret){$("#ivtStepPay").attr("class","t1 on");$("#ivtStepIvt").attr("class","t2")}else{$("#ivtStepPay").attr("class","t1");$("#ivtStepIvt").attr("class","t2 on")}$("#ivtStep").show()},init:function(type){switch(type){case 1:$("#inviteText").focus(function(){this.select()});$("#fi5").blur(function(){self.checkMsnUserName(false)});$("#fi5").keydown(self.enterEvent);$("#msn_password").keydown(self.enterEvent);$("#searchIvtA").bind("click",self.login);$("#ivtmsn").hide();$("#ivtmsnT").hide();$("#mailView").hide();$("#ivtErr").hide();$("#ivtStep").hide();$("#copyHrf").bind("click",self.copyCode);$("#ivtLab").bind("click",self.inviteSelect);break;case 2:var chkAll=$(":checkbox[name=chkusrMSN]");if(chkAll.length<=0){self.init(4);return}chkAll.each(function(){$(this).attr("checked",true)});$("#ivtmsnT").show();$("#mailView").show();self.showStep(false);$("#allChkMSN").attr("checked",true);$("#allChkMSN").click(function(){self.chkAll("chkusrMSN","allChkMSN")});$("#sdMsnE").bind("click",function(){self.sendMail("chkusrMSN")});break;case 3:$("#ivtmsn").show();self.showStep(true);$("#allChkIVT").attr("checked",true);$(":checkbox[name=chkusrIVT]").each(function(){$(this).attr("checked",true)});$("#allChkIVT").bind("click",function(){self.chkAll("chkusrIVT","allChkIVT")});$("#payIvtF").bind("click",function(){self.payAttd("chkusrIVT")});$("a[class='fuc1']").bind("click",function(){$("#ivtmsn").hide();self.init(2)});break;case 4:$("#ivtErr").show();$("#ivtErrA").bind("click",function(){window.location.reload()});break;default:return}}})};return msnivt});kola("newt.friend.Recommend",["jquery.Core","kola.lang.Class","kola.lang.Function","newt.twitter.Twitter","newt.plug.RadioClass","newt.ca.ca"],function(b,a,d){var c=a.create({_init:function(g,f){var e=this;this.opts=b.extend({caConfig:"newt_friend_recommend_",concernSel:"a.concern",numberSel:"strong.num",selectSel:"div.uSelectItem",checkedAllSel:"a.checkedAll",opositeCheckedSel:"a.opositeChecked",moreSel:"div.more",showMoreSel:"p.recomMore",selectedSel:"div.selected",selectedCls:"selected",concernedTip:"div.noCnt",defaultNum:24,moreNum:24,concernOKHandle:function(){common.showTip("关注成功！");e._removeSelecteds();e._recaculateNum();CRTWCONFIG.SCROLL_DOM.scrollTo(b("div.land"),200,{axis:"y",offset:-50})}},f||{});this.elem=b(g);this.cache={};this.curList=null;this._initElements();this._bindEvents();this._initNav()},_initNav:function(){var e=this;var f=b(".tabsVertical").find("a");f.each(function(){b(this).attr("href","javascript:void(0)")});e.curList=b(".uListSelect");b(".tabsVertical").RadioClass({tag:"li",clicktag:"a",afterclick:function(h){var i=h.attr("data-cid");CA.q(e.opts.caConfig+"channel_"+i);var g=b("#uList_"+i);if(i>=0&&i!=e.curCid&&g.size()==0){e._getChannel(i,function(){g=b("#uList_"+i);b("[id^=uList_]").addClass("noDis");g.removeClass("noDis");e.curCid=i;e.curList=g;e._recaculateNum()})}else{b("[id^=uList_]").addClass("noDis");g.removeClass("noDis");e.curList=g;e._recaculateNum();if(e.curList.find(e.opts.selectSel).size()==0){e.showMoreBtn.addClass("noDis")}else{e.showMoreBtn.removeClass("noDis")}}}})},_getChannel:function(h,f){var e=this;var g={cid:h};b.ajax({url:"/regist/recommends_action",data:g,dataType:"json",type:"post",success:function(i){if(i.status==0){e._showData(i.data,h);f()}},error:function(i,j){}})},_showData:function(j,l){var g=this;var h=0,e=0,k=[],f="";e=j.length;f="uList_"+l;k.push('<div id="'+f+'" class="uListSelect noDis">');if(e==0){k.push('<div class="noCnt"><p class="ttl">推荐列表为空 </p></div>')}for(h=0;h<e;h++){if(h==g.opts.defaultNum){k.push('<div class="more" style="display:none;">')}k.push('<div class="uSelectItem selected" uid="'+j[h].uid+'" alt="'+j[h].desc+'" title="'+j[h].desc+'">');k.push('<p class="status"></p>');k.push('<p class="avt avt48"><i data-content=\'{"type":"nick", "nick":"'+j[h].uname+'"}\' style="background-image: url('+j[h].icon+');" class="img"></i></p>');k.push('<b class="nm"><b data-content=\'{"type":"nick", "nick":"'+j[h].uname+"\"}'>"+j[h].uname+"</b></b>");k.push('<p class="ps">'+j[h].desc+"</p>");k.push("</div>")}if(e>g.opts.defaultNum){k.push("</div>")}k.push("</div>");if(b(f).size()>0){b(f).remove()}if(e>g.opts.defaultNum){g.showMoreBtn.removeClass("noDis")}else{g.showMoreBtn.addClass("noDis")}b(".recomList").append(k.join(""))},_initElements:function(){this.concernElm=this.elem.find(this.opts.concernSel);this.numberElm=this.elem.find(this.opts.numberSel);this.checkedAllElm=this.elem.find(this.opts.checkedAllSel);this.opositeCheckedElm=this.elem.find(this.opts.opositeCheckedSel);this.showMoreBtn=this.elem.find(this.opts.showMoreSel);this._recaculateNum()},_bindEvents:function(){this._bindCheckEvent();this.checkedAllElm.unbind("click").click(d.bind(this._checkAll,this));this.opositeCheckedElm.unbind("click").click(d.bind(this._opositeCheck,this));this.showMoreBtn.unbind("click").click(d.bind(this._showMore,this));this.concernElm.unbind("click").click(d.bind(this._concern,this))},_bindCheckEvent:function(){var e=this;this.elem.find(this.opts.selectSel).live("click",function(){if(b(this).hasClass(e.opts.selectedCls)){b(this).removeClass(e.opts.selectedCls);e.selectedNum--}else{b(this).addClass(e.opts.selectedCls);e.selectedNum++}e._changeNumTip()})},_checkAll:function(){var e=this.elem.find(this.opts.selectSel).filter(":visible");e.addClass(this.opts.selectedCls);this.selectedNum=e.length;this._changeNumTip();CA.q(this.opts.caConfig+"checkAll")},_opositeCheck:function(){var e=this;this.elem.find(this.opts.selectSel).filter(":visible").each(function(){if(b(this).hasClass(e.opts.selectedCls)){b(this).removeClass(e.opts.selectedCls);e.selectedNum--}else{b(this).addClass(e.opts.selectedCls);e.selectedNum++}});this._changeNumTip();CA.q(this.opts.caConfig+"opositeCheck")},_changeNumTip:function(e){if(typeof(e)!=="undefined"){this.selectedNum=e}this.numberElm.html(this.selectedNum)},_recaculateNum:function(){var e=this;this.selectedNum=0;this.elem.find(".uListSelect").children(this.opts.selectSel).each(function(){if(b(this).hasClass(e.opts.selectedCls)){e.selectedNum++}});this._changeNumTip()},_getSelUserIds:function(){var f=[],e=this;this.elem.find(".uListSelect").children(this.opts.selectSel).each(function(){if(b(this).hasClass(e.opts.selectedCls)){f.push(b(this).attr("uid"))}});return f.join(",")},_showMore:function(){var g=this;var f=g.curList;var h=f.find(this.opts.moreSel);var i=true;if(h){var e=f.find(this.opts.moreSel).find(this.opts.selectSel);i=e.size()<=this.opts.moreNum;if(e.size()>this.opts.moreNum){h.before(e.slice(0,this.opts.moreNum).addClass(this.opts.selectedCls))}else{h.before(e.addClass(this.opts.selectedCls))}}if(i){this.showMoreBtn.addClass("noDis")}this._recaculateNum();CA.q(this.opts.caConfig+"showMore")},_concern:function(){var e=this;tw.build({type:"follow_from_active",uid:e._getSelUserIds(),success:function(f){if(f.status==0){if(typeof(e.opts.concernOKHandle)=="function"){e.opts.concernOKHandle(f)}}},error:function(){common.showTip("关注失败！")}})},_removeSelecteds:function(){var g=this;var f,j,h,k,e;this.elem.find(".uListSelect").each(function(){var i=b(this);f=i.find(g.opts.moreSel).find(g.opts.selectSel);j=f.size();h=0;i.children(g.opts.selectSel).each(function(){var l=b(this);if(l.hasClass(g.opts.selectedCls)){i.find("");if(h<j){l.replaceWith(f[h])}else{l.remove()}h++}});k=i.find(g.opts.concernedTip);e=i.find(g.opts.selectSel);if((e.size()==0)&&(k.size()==0)){i.html('<div class="noCnt"><p class="ttl">一口气关注了不少人哦，<a href="/home">去首页看看</a> 他们都在说些什么吧 </p></div>')}});if(g.curList.find(g.opts.selectSel).size()==0){g.showMoreBtn.addClass("noDis")}}});return c});